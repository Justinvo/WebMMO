<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WebMMO by JustinVanOort</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
  <link rel="stylesheet" href="style.css">
  </link>
  <!-- let's initialize firebase features -->
  <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-app.js"></script>
  <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
  <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-analytics.js"></script>
  <!-- Add Firebase products that you want to use -->
  <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-functions.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-messaging.js"></script>
  <script src="config.js"></script>
  <script src="common.js"></script>
  <script src="https://www.gstatic.com/firebasejs/ui/4.7.3/firebase-ui-auth.js"></script>
  <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.7.3/firebase-ui-auth.css" />
  <!-- Font used by this page-->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
    crossorigin="anonymous"></script>
  <script>
    var userObject;
    var userID;
    $(document).ready(function () {
      $("body").tooltip({ selector: '[data-toggle=tooltip]' });
    });
    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        //If the user is not logged in, move to the log-in screen.
        window.location = 'index.html';
      }
      else {
        //If we have confirmed that the user is logged in, start the game.
        userObject = user;
        userID = user.uid;
        document.getElementById("user-name").innerText = "Logged in as: " + user.displayName;
        //Check if our user has a hero, if they do continue, if they don't send them to the hero screen.
        db.collection("users").doc(userID).get().then((doc) => {
          if(!doc.data()) window.location = 'hero.html'
          if(!doc.data().name) window.location = 'name.html'
        })
        initGame();
      }
    });
  </script>


</head>
<!-- Game code-->

<body>
  <div class="game-container">
    <div class="toppane">
      WebMMO
      <div id="user-name"></div>
    </div>
    <div class="leftpane">
      <!-- Start of the left panel-->
      <h1>Hero Information</h1>
      <!-- End of the left panel-->
      <p></p>
      <ul class="list-group list-group-flush"></ul>
      <li class="list-group-item" data-toggle="tooltip" data-bs-placement="top" title="The name of your hero!">Hero
        Name: <span class="badge bg-secondary">Justin</span></li>
      <li class="list-group-item" data-toggle="tooltip" data-bs-placement="top"
        title="Your Hero's level is a representation of their strength and experience.">Hero Level: <span
          class="badge bg-secondary">10</span></li>
      <li class="list-group-item" data-toggle="tooltip" data-bs-placement="top"
        title="Your Hero's class determines the skills and perks your Hero has.">Hero Class: <span
          class="badge bg-secondary">Ranger</span></li>
      </ul>
    </div>
    <div class="middlepane">
      <!-- Start of the middle panel-->
      <h1>Current Location: </h1>
      <h2>
        <div id="current-location-text"></div>
      </h2>
      <p>
      <div id="current-location-players-amount-text">There are currently 0 players in the Town Center.</div>
      <p></p>
      <p>
        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
          Show Players
        </button>
      </p>
      <div class="collapse" id="collapseExample">
        <div>
          <ul id="current-location-players-names-list" class="list-group list-group-flush">
  
          </ul>
        </div>
      </div>
      </p>

      <!-- End of the middle panel-->
    </div>
    <div class="rightpane">
      <!-- Start of the right panel-->
      <h1>Game Menu</h1>
      <div class="list-group">
        <button id="sign-out" class="list-group-item list-group-item-action list-group-item-warning">Sign-out</button>
      </div>
      <!-- End of the right panel-->
    </div>
  </div>
  <!-- actual game code -->
  <script>
    //Globals:
    var currentLocation;
    //Start the game as soon as we are logged in.
    function initGame() {
        //Initialize our character.
        pullCharacterInfo();
        updateLocation("Town Center");
      }
    
    //Change the current location of the player.
    function updateLocation(newLocation) {
      if(currentLocation)
      {
        // Atomically remove the player from the previous location, if necessary.
        let locRef = db.collection('locations').doc(currentLocation);
        locRef.update({
          players: firebase.firestore.FieldValue.arrayRemove(userID)
        });
      }
      //Update the location first.
      currentLocation = newLocation;
      let locText = document.getElementById("current-location-text");
      locText.innerText = currentLocation
      //Unsubscribe from any  previous listeners
      if (locAmountSubscription) locAmountSubscription();
      //Add our player id to the location list of our new location.
      let locRef = db.collection('locations').doc(currentLocation);
      locRef.update({
        players: firebase.firestore.FieldValue.arrayUnion(userID)
      });
      //Keep track of how many players are here. Auto updates if this changes.
      let locAmountText = document.getElementById("current-location-players-amount-text");
      var locAmountSubscription = db.collection("locations").doc(currentLocation)
        .onSnapshot((doc) => {
          if (doc.data().players.length != 1) {
            locAmountText.innerText = "There are currently " + doc.data().players.length + " players in the " + currentLocation;
          }
          else {
            locAmountText.innerText = "There is currently 1 player in the " + currentLocation;
          }
          //Update the player names list.
          $('#current-location-players-names-list').html('');
          doc.data().players.forEach( element => {
            let nameRef = db.collection("users").doc(element);
            nameRef.get().then((doc) => {
              let name = doc.data().name;
              $('#current-location-players-names-list').append(`<li class="list-group-item">${name}</li>`);  
            })
            
          });
        });


    }
    
    //Get our character's info.
    function pullCharacterInfo() {

    }

  </script>
</body>
<script src="app.js"></script>

</html>